## filtrados
# codigo paso 1
bbduk.sh -Xmx2g threads=1 \
in1=~/181004_curso_calidad_datos_NGS/fastq_raw/S3_R1.fastq.gz \
in2=~/181004_curso_calidad_datos_NGS/fastq_raw/S3_R2.fastq.gz \
out1=./S3_R1_filter1.fastq.gz \
out2=./S3_R2_filter1.fastq.gz \
ref=~/resources/bbmap/adapters.fa tpe tbo

#Codigo paso 2
bbduk.sh -Xmx2g threads=1 \
in1=./S3_R1_filter1.fastq.gz \
in2=./S3_R2_filter1.fastq.gz \
out1=./S3_R1_filter2.fastq.gz \
out2=./S3_R2_filter2.fastq.gz \
ref=~/resources/bbmap/phix174_ill.ref.fa.gz

#codigo paso 3
bbduk.sh -Xmx2g threads=1 \
in1=./S3_R1_filter2.fastq.gz \
in2=./S3_R2_filter2.fastq.gz  \
out1=./S3_R1_filter3.fastq.gz \
out2=./S3_R2_filter3.fastq.gz \
qtrim=w trimq=20 minlength=30 minavgquality=20

## Alineamientos
bwa mem -t 4 -M /datos/reference/genomes/hg19_reference/hg19.fasta \
./S3_R1_filter3.fastq.gz \
./S3_R1_filter3.fastq.gz \
> S3.sam

# convertir sam a bam
java -jar /opt/picard/picard-2.25.2/picard.jar SamFormatConverter -I S3.sam -O S3.bam

#ordenar lecturas alineadas por posicion
java -jar /opt/picard/picard-2.25.2/picard.jar SortSam -I S3.bam -O S3_sorted.bam -SO coordinate

#AÃ±adir el campo Readgroup al archivo bam
java -jar /opt/picard/picard-2.25.2/picard.jar AddOrReplaceReadGroups -I S3_sorted.bam -O S3_sorted_RG.bam -ID sample -LB Paired-end -PL Illumina -PU Unknown -SM sample

#indexar alineamiento
samtools index S3_sorted_RG.bam
#se creo el archivo S3_sorted_RG.bam.bai

#reporte de calidad
qualimap bamqc -bam S3_sorted_RG.bam -gff ~/181004_curso_calidad_datos_NGS/regiones_blanco.bed -outdir ./S3_sorted_RG


## LLamado de variantes
java -jar /opt/GenomeAnalysisTK-3.7-0/GenomeAnalysisTK.jar -T BaseRecalibrator -R /datos/reference/genomes/hg19_reference/hg19.fasta -I S3_sorted_RG.bam -knownSites /datos/reference/genomes/hg19_reference/dbSNP_hg19.vcf -o S3_recall_data.table

java -jar /opt/GenomeAnalysisTK-3.7-0/GenomeAnalysisTK.jar -T PrintReads -R  /datos/reference/genomes/hg19_reference/hg19.fasta -I S3_sorted_RG.bam --BQSR S3_recall_data.table -o S3_recall_reads.bam

java -jar /opt/GenomeAnalysisTK-3.7-0/GenomeAnalysisTK.jar -T HaplotypeCaller -R /datos/reference/genomes/hg19_reference/hg19.fasta -I S3_recall_reads.bam --dbsnp /datos/reference/genomes/hg19_reference/dbSNP_hg19.vcf -stand_call_conf 30 -L "chr19" -o S3_raw_variants.vcf

java -jar /opt/GenomeAnalysisTK-3.7-0/GenomeAnalysisTK.jar -T SelectVariants -R /datos/reference/genomes/hg19_reference/hg19.fasta -V S3_raw_variants.vcf -selectType SNP -o S3_RAW_SNP.vcf

java -jar /opt/GenomeAnalysisTK-3.7-0/GenomeAnalysisTK.jar -T VariantFiltration -R /datos/reference/genomes/hg19_reference/hg19.fasta -V S3_RAW_SNP.vcf --filterExpression "DP <10" --filterName "FILTER" -o S3_FILTERED_SNP.vcf


java -jar /opt/GenomeAnalysisTK-3.7-0/GenomeAnalysisTK.jar -T SelectVariants -R /datos/reference/genomes/hg19_reference/hg19.fasta -V S3_raw_variants.vcf -selectType INDEL -o S3_RAW_INDEL.vcf

java -jar /opt/GenomeAnalysisTK-3.7-0/GenomeAnalysisTK.jar -T VariantFiltration -R /datos/reference/genomes/hg19_reference/hg19.fasta -V S3_RAW_INDEL.vcf --filterExpression "DP <10" --filterName "FILTER" -o S3_FILTERED_INDEL.vcf

java -jar /opt/GenomeAnalysisTK-3.7-0/GenomeAnalysisTK.jar -T CombineVariants -R /datos/reference/genomes/hg19_reference/hg19.fasta --variant:foo S3_FILTERED_SNP.vcf --variant:bar S3_FILTERED_INDEL.vcf -o S3_FILTER_VARIANTS.vcf -genotypeMergeOptions PRIORITIZE -priority foo,bar

#DP<30
java -jar /opt/GenomeAnalysisTK-3.7-0/GenomeAnalysisTK.jar -T VariantFiltration -R /datos/reference/genomes/hg19_reference/hg19.fasta -V S3_RAW_SNP.vcf --filterExpression "DP <30" --filterName "FILTER" -o S3_FILTERED_SNP_30.vcf

java -jar /opt/GenomeAnalysisTK-3.7-0/GenomeAnalysisTK.jar -T VariantFiltration -R /datos/reference/genomes/hg19_reference/hg19.fasta -V S3_RAW_INDEL.vcf --filterExpression "DP <30" --filterName "FILTER" -o S3_FILTERED_INDEL_30.vcf
